#!/bin/bash

set -euo pipefail

basedir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && cd .. && pwd )"

job_name="${BUILDKITE_PIPELINE_SLUG}-${BUILDKITE_BUILD_NUMBER}-${BUILDKITE_JOB_ID}"

function cleanup {
  # Delete all jobs older than a day
  kubectl delete job $(kubectl get job -l buildkite/plugin=k8s | awk 'match($5,/[0-9]+d/) {print $1}') 2>/dev/null || true
}
trap cleanup EXIT


function tail_logs {
  while true ; do
    stdbuf -oL -eL kubectl logs -f "job/${job_name}" 2>>/dev/null || true
    sleep 0.2
  done
}

echo "--- :kubernetes: Starting Kubernetes Job ($(kubectl config current-context))"

jsonnet \
  --tla-str "jobName=${job_name}" \
  --tla-code "agentEnv=$(jq -c -n env)" \
  "${basedir}/lib/job.jsonnet" \
  | kubectl apply -f -

echo "+++ :kubernetes: Running image: ${BUILDKITE_PLUGIN_K8S_IMAGE}"

tail_logs &
kubectl wait --for=condition=complete "job/${job_name}"
sleep 0.2
